@model PagedResult<dynamic>
@using Do_an_NoSQL.Helpers
@functions {
    string SortIcon(string field)
    {
        string sort = (ViewBag.Sort ?? "").ToString();

        return sort switch
        {
            "price_asc" when field == "price" => "fa-sort-up",
            "price_desc" when field == "price" => "fa-sort-down",
            "date_asc" when field == "date" => "fa-sort-up",
            "date_desc" when field == "date" => "fa-sort-down",
            "term_asc" when field == "term" => "fa-sort-up",
            "term_desc" when field == "term" => "fa-sort-down",
            _ => "fa-sort"
        };
    }
}



@{
    // Danh sách loại bảo hiểm và màu tương ứng
    var typeStats = new List<(string Code, string Name, string Color)>
    {
        ("endowment", "Tích lũy", "linear-gradient(135deg, #0284ff, #00d1ff)"),
        ("term", "Tử kỳ", "linear-gradient(135deg, #ff6a00, #ff9500)"),
        ("whole_life", "Trọn đời", "linear-gradient(135deg, #8e44ad, #c0392b)"),
        ("retirement", "Hưu trí", "linear-gradient(135deg, #e82c70, #ff5ba6)"),
        ("health", "Sức khỏe", "linear-gradient(135deg, #16a085, #27ae60)"),
        ("accident", "Tai nạn", "linear-gradient(135deg, #009e60, #0666d0)"),
        ("education", "Giáo dục", "linear-gradient(135deg, #f39c12, #f1c40f)")
    };

    // Tính tổng sản phẩm
    var totalProducts = Model.TotalItems;
}

<div class="row py-3 g-3">
    <!-- Tổng hợp sản phẩm -->
    <div class="col-md-3 col-sm-6">
        <div class="stat-card" style="background: linear-gradient(135deg, #ff3b3f, #ff8a00);">
            <div class="stat-overlay"></div>
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <p class="text-white text-uppercase mb-1">Tổng hợp sản phẩm</p>
                    <h4 class="text-white fw-bold">@totalProducts</h4>
                </div>
                <div class="stat-icon-box">
                    <i class="fa-solid fa-box-archive text-white fs-4"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Loop từng loại bảo hiểm -->
    @foreach (var item in typeStats)
    {
        var count = Model.Items.Count(x => x.Type == item.Code);

        <div class="col-md-3 col-sm-6">
            <div class="stat-card" style="background: @item.Color;">
                <div class="stat-overlay"></div>
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <p class="text-white text-uppercase mb-1">@item.Name</p>
                        <h4 class="text-white fw-bold">@count</h4>
                    </div>
                    <div class="stat-icon-box">
                        <i class="fa-solid fa-shield-halved text-white fs-4"></i>
                    </div>
                </div>
            </div>
        </div>
    }
</div>


<div class="main-card">
    <!-- Header -->
    <div class="main-header">
        <div>
            <h3>DANH SÁCH SẢN PHẨM BẢO HIỂM</h3>
            <p>Theo dõi, lọc và quản lý sản phẩm bảo hiểm</p>
        </div>

        <div class="d-flex flex-wrap gap-2">
            <a href="/Products/DownloadTemplate" class="btn btn-outline-red">
                <i class="fa-solid fa-file-arrow-down me-1"></i> Tải file mẫu
            </a>
            @if (RoleHelper.CanManageProducts(User))
            {
                <a href="#" class="btn btn-red" data-bs-toggle="modal" data-bs-target="#importModal">
                    <i class="fa-solid fa-file-import me-1"></i> Import Excel
                </a>
            }
            @if (RoleHelper.CanViewProducts(User))
            {
                <a href="javascript:void(0);" id="exportExcelBtn" class="btn btn-outline-red">
                    <i class="fa-solid fa-file-export me-1"></i>Xuất Excel
                </a>
            }
            @if (RoleHelper.CanManageProducts(User))
            {
                <a href="@Url.Action("Create")" class="btn btn-red">
                    <i class="fa-solid fa-plus me-1"></i>Thêm sản phẩm
                </a>
            }
        </div>
    </div>

    <div class="filter-section">
        <form method="get" id="filterForm">
            <input type="hidden" name="per_page" value="@Model.PageSize" />

            <div class="row mb-2 align-items-end ">
                <div class="col-md-3 position-relative">
                    <i class="fa-solid fa-magnifying-glass search-icon mr-1"></i>
                    <input type="text" class="input-input" style="padding-left: 30px;" name="search"
                           value="@ViewBag.Search" placeholder="Mã sản phẩm, tên sản phẩm ...">

                </div>
                <div class="col-md-3">
                    <select name="type" class="select-input" onchange="this.form.submit()">
                        <option value="">Tất cả loại sản phẩm</option>
                        @foreach (var typeOption in ViewBag.Type as List<string>)
                        {
                            var isSelected = ViewBag.SelectedType == typeOption;
                            <option value="@typeOption" selected="@isSelected">
                                @GetTypeName(typeOption)
                            </option>
                        }
                    </select>


                    @{
                        string GetTypeName(string type)
                        {
                            switch (type)
                            {
                                case "endowment": return "Bảo hiểm tích lũy";
                                case "term": return "Bảo hiểm tử kỳ";
                                case "whole_life": return "Bảo hiểm trọn đời";
                                case "retirement": return "Bảo hiểm hưu trí";
                                case "health": return "Bảo hiểm sức khỏe";
                                case "accident": return "Bảo hiểm tai nạn";
                                case "education": return "Bảo hiểm giáo dục";
                                default: return "Không xác định";
                            }
                        }
                    }

                </div>


                <div class="row col-md-6 align-items-end ">
                <div class="col-md-5">
                    <label class="form-label fw-semibold">Giá bảo hiểm (VNĐ)</label>
                    <input type="number" class="input-input" name="sum_assured_value"
                           value="@ViewBag.SumAssuredValue"
                           placeholder="Nhập giá cần lọc..."
                           onchange="this.form.submit()">
                </div>

                <div class="col-md-5">
                    <label class="form-label fw-semibold">Tuổi</label>
                    <input type="number" class="input-input" name="age_value"
                           value="@ViewBag.AgeValue"
                           placeholder="Nhập tuổi cần lọc..."
                           onchange="this.form.submit()">
                </div>
                <div class="col-md-1 d-flex justify-content-center">
                    <button type="button" class="btn-outline-red" style="height:42px;" onclick="window.location='@Url.Action("Index")'">
                        <i class="fa-solid fa-rotate-left"></i>
                    </button>
                    </div>
                </div>

            </div>
            <button type="submit" style="display:none"></button>
        </form>
        @if (RoleHelper.CanManageProducts(User))
        {
            <div class="mt-4 d-flex gap-3">
                <button type="button" class="btn-outline-red" onclick="bulkDeleteProducts()">
                    <i class="fa-solid fa-trash-can me-1"></i>
                    Xóa hàng loạt
                </button>
            </div>
        }
    </div>

    <!-- TABLE -->
    <div class="table-wrapper">
        <table class="table align-middle mb-0">
            <thead class="text-center">
                <tr>
                    <th>
                        <div class="d-flex align-items-center gap-2">
                            <input type="checkbox" id="checkAll">
                            <span>STT</span>
                        </div>
                    </th>
                    <th>MÃ SẢN PHẨM</th>
                    <th>TÊN SẢN PHẨM</th>
                    <th>
                        PHÍ BẢO HIỂM
                    </th>
                    <th>
                        TUỔI
                    </th>
                    <th>
                        THỜI GIAN
                        <a href="?sort=@(ViewBag.Sort == "term_asc" ? "term_desc" : "term_asc")">
                            <i class="fa-solid @SortIcon("term") ms-1"></i>
                        </a>
                    </th>
                    <th>THAO TÁC</th>
                </tr>
            </thead>

            <tbody>
                @if (Model.Items.Any())
                {
                    var index = (Model.CurrentPage - 1) * Model.PageSize + 1;

                    foreach (var p in Model.Items)
                    {
                        <tr class="text-center">
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <input type="checkbox" class="row-check" value="@p.Id">
                                    <span>@index</span>
                                </div>
                            </td>

                            <td class="fw-semibold text-primary">@p.ProductCode</td>
                            <td>@p.Name</td>
                            <td class="text-center">@String.Format("{0:N0} ₫", p.MinSumAssured) - @String.Format("{0:N0} ₫", p.MaxSumAssured)</td>
                            <td>@p.MinAge - @p.MaxAge</td> 
                            <td>@p.TermYears</td>
                            <td class="text-center">
                                <button type="button" class="btn btn-action-dropdown" data-bs-toggle="dropdown">
                                    <i class="fa-solid fa-gear"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item d-flex align-items-center gap-2 text-success"
                                           href="javascript:void(0);" onclick="viewProductDetails('@p.Id')">
                                            <i class="fa-solid fa-eye"></i>
                                            <span>Xem chi tiết</span>
                                        </a>
                                    </li>

                                    <!-- Chỉnh sửa -->
                                    <li>
                                        <a class="dropdown-item d-flex align-items-center gap-2 text-primary"
                                           asp-action="Edit" asp-route-id="@p.Id">
                                            <i class="fa-solid fa-pen"></i>
                                            <span>Chỉnh sửa</span>
                                        </a>
                                    </li>

                                    <!-- Xóa -->
                                    <li>
                                        <button type="button"
                                                class="dropdown-item d-flex align-items-center gap-2 text-danger"
                                                onclick="confirmDeleteProduct('@p.Id')">
                                            <i class="fa-solid fa-trash-can"></i>
                                            <span>Xóa</span>
                                        </button>
                                    </li>
                                </ul>
                            </td>
                        </tr>

                        index++;
                    }
                }
                else
                {
                    <tr>
                        <td colspan="7" class="py-4 text-center text-muted fst-italic">
                            Không có sản phẩm nào được tìm thấy.
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Footer -->
    <div class="table-footer">
        @await Html.PartialAsync("_Paginator", Model)
    </div>

    <!-- MODAL: Chi tiết sản phẩm -->
    <div class="modal fade" id="productDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg">

                <!-- HEADER -->
                <div class="modal-header custom-header">
                    <div class="d-flex align-items-center gap-3">
                        <div class="header-icon">
                            <i class="fa-solid fa-shield-halved"></i>
                        </div>
                        <div>
                            <h3 class="mb-0 text-white fw-bold">Chi tiết sản phẩm bảo hiểm</h3>
                            <p class="mb-0 text-white-75 small" id="modalProductCode"></p>
                        </div>
                    </div>
                    <button type="button" class="btn-close btn-gray" data-bs-dismiss="modal"></button>
                </div>

                <!-- BODY -->
                <div class="modal-body custom-modal-body" id="productDetailBody">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3 text-muted">Đang tải thông tin sản phẩm...</p>
                    </div>
                </div>

                <!-- FOOTER -->
                <div class="modal-footer custom-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-sm btn-gray" data-bs-dismiss="modal">
                        Đóng
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Import Excel -->
    <div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">

                <!-- HEADER -->
                <div class="modal-header custom-header rounded-top-4">
                    <div class="d-flex align-items-center gap-3">
                        <div class="header-icon">
                            <i class="fa-solid fa-file-import"></i>
                        </div>
                        <div>
                            <h3 class="mb-0 text-white fw-bold">Import Sản Phẩm Bảo Hiểm</h3>
                            <p class="mb-0 text-white-75 small">Tải lên file Excel theo mẫu</p>
                        </div>
                    </div>
                    <button type="button" class="btn-close btn-gray" data-bs-dismiss="modal"></button>
                </div>

                <!-- BODY -->
                <div class="modal-body custom-modal-body">
                    <form id="importExcelForm" enctype="multipart/form-data" class="p-2">
                        <div class="mb-4">
                            <label class="form-label fw-semibold">Chọn file Excel</label>
                            <div class="upload-box text-center p-4 border border-2 rounded-3 bg-light hover-shadow-sm">
                                <i class="fa-solid fa-cloud-arrow-up fa-2x text-danger mb-2"></i>
                                <p class="mb-1 fw-semibold">Kéo thả file vào đây hoặc</p>
                                <button type="button" id="importExcelBtn" class="btn btn-red btn-sm">
                                    <i class="fa-solid fa-upload me-1"></i> Chọn tệp
                                </button>
                                <input type="file" id="importExcelInput" name="file" class="d-none" accept=".xlsx,.xls">
                                <p id="selectedFileName" class="mt-2 text-muted fst-italic">Chưa chọn tệp</p>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-3">
                            <button type="button" class="btn btn-sm btn-gray" data-bs-dismiss="modal">
                                Đóng
                            </button>
                                <button type="submit" class="btn btn-red">
                                    <i class="fa-solid fa-check me-1"></i> Bắt đầu import
                                </button>
                        </div>
                        
                    </form>
                </div>


            </div>
        </div>
    </div>


</div>

@section Scripts {
    <script src="~/js/products.js"></script>
}
