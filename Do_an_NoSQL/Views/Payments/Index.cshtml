@model PagedResult<dynamic>
@{
    ViewData["Title"] = "Quản lý thanh toán & chi trả quyền lợi";
    string activeTab = ViewBag.ActiveTab ?? "premium";
}


    <link rel="stylesheet" href="~/css/payment.css" asp-append-version="true" />

<!-- ========================== -->
<!-- HEADER -->
<!-- ========================== -->
<div class="main-card">
    <div class="main-header">
        <div>
            <h3>QUẢN LÝ THANH TOÁN & CHI TRẢ</h3>
            <p>Theo dõi lịch sử đóng phí và chi trả quyền lợi bảo hiểm</p>
        </div>
    </div>

    <!-- ========================== -->
    <!-- MODERN TABS -->
    <!-- ========================== -->
    <ul class="payment-tabs">
        <li class="tab-item">
            <a class="tab-link @(activeTab == "premium" ? "active" : "")"
               href="@Url.Action("Index", new { tab = "premium" })"
               data-tab="premium">
                <i class="fa-solid fa-wallet"></i>
                <span>Lịch sử đóng phí</span>
            </a>
        </li>
        <li class="tab-item">
            <a class="tab-link @(activeTab == "payout" ? "active" : "")"
               href="@Url.Action("Index", new { tab = "payout" })"
               data-tab="payout">
                <i class="fa-solid fa-hand-holding-dollar"></i>
                <span>Chi trả quyền lợi</span>
            </a>
        </li>
    </ul>

    <!-- ========================== -->
    <!-- TAB CONTENT -->
    <!-- ========================== -->
    <div class="tab-content-wrapper">
        @if (activeTab == "premium")
        {
            <!-- ========================== -->
            <!-- TAB: PREMIUM PAYMENTS -->
            <!-- ========================== -->
            <div class="filter-section mb-4">
                <form method="get" id="filterForm">
                    <input type="hidden" name="tab" value="premium" />
                    <div class="row mb-4 align-items-end">
                        <div class="col-md-4 position-relative">
                            <i class="fa-solid fa-magnifying-glass search-icon"></i>
                            <input type="text" name="search" value="@ViewBag.Search"
                                   class="input-input ps-5" placeholder="Tìm mã hợp đồng, tham chiếu...">
                        </div>

                        <div class="col-md-4">
                            <select name="status" class="select-input" onchange="this.form.submit()">
                                <option value="">Tất cả trạng thái</option>
                                <option value="paid" selected="@(ViewBag.Status == "paid")">Đã thanh toán</option>
                                <option value="pending" selected="@(ViewBag.Status == "pending")">Đang chờ</option>
                                <option value="overdue" selected="@(ViewBag.Status == "overdue")">Quá hạn</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select name="channel" class="select-input" onchange="this.form.submit()">
                                <option value="">Tất cả kênh</option>
                                <option value="bank" selected="@(ViewBag.Channel == "bank")">Ngân hàng</option>
                                <option value="agent" selected="@(ViewBag.Channel == "agent")">Tư vấn viên</option>
                                <option value="office" selected="@(ViewBag.Channel == "office")">Văn phòng công ty</option>
                            </select>
                        </div>
                    </div>

                        <div class="row mb-2 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">Từ ngày</label>
                            <input type="date" name="from_date" class="input-input" value="@ViewBag.FromDate">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">Đến ngày</label>
                            <input type="date" name="to_date" class="input-input" value="@ViewBag.ToDate">
                        </div>
                        <div class="col-md-2 d-flex justify-content-start">
                            <button type="button" class="btn-outline-red"
                                    style="height:42px;"
                                    onclick="window.location='@Url.Action("Index", new { tab = "premium" })'">
                                <i class="fa-solid fa-rotate-left"></i>
                            </button>
                        </div>
                    </div>
                </form>

            </div>


            <div class="table-wrapper mt-3">
                <table class="table align-middle mb-0">
                    <thead class="text-center">
                        <tr>
                            <th>
                                    <span>STT</span>
                            </th>
                            <th>MÃ HỢP ĐỒNG</th>
                            <th>NGÀY ĐẾN HẠN</th>
                            <th>NGÀY THANH TOÁN</th>
                            <th>SỐ TIỀN (₫)</th>
                            <th>TRẠNG THÁI</th>
                            <th>KÊNH THANH TOÁN</th>
                            <th>THAM CHIẾU</th>
                            <th>THAO TÁC</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Items.Any())
                        {
                            var index = (Model.CurrentPage - 1) * Model.PageSize + 1;
                            foreach (var p in Model.Items)
                            {
                                <tr class="text-center">
                                    <td>
                                            <span>@index</span>
                                    </td>
                                    <td class="fw-semibold text-primary">@p.PolicyNo</td>
                                    <td>@p.DueDate.ToString("dd/MM/yyyy")</td>
                                    <td>@(p.PaidDate != null ? ((DateTime)p.PaidDate).ToString("dd/MM/yyyy") : "-")</td>
                                    <td>@String.Format("{0:N0}", p.Amount)</td>
                                    <td>
                                        @switch (p.Status)
                                        {
                                            case "paid":
                                                <span class="badge-status status-paid">Đã thanh toán</span>
                                                break;
                                            case "pending":
                                                <span class="badge-status status-pending">Đang chờ</span>
                                                break;
                                            case "overdue":
                                                <span class="badge-status status-overdue">Quá hạn</span>
                                                break;
                                            default:
                                                <span class="badge-status bg-secondary">@p.Status</span>
                                                break;
                                        }
                                    </td>
                                    <td>
                                        @{
                                            var channelVN = p.Channel switch
                                            {
                                                "bank" => "Ngân hàng",
                                                "mobile_app" => "Ứng dụng di động",
                                                "website" => "Website Prudential",
                                                "agent" => "Tư vấn viên",
                                                "office" => "Văn phòng công ty",
                                                _ => p.Channel ?? "-"
                                            };
                                        }
                                        @channelVN
                                    </td>
                                    <td>@(p.Reference ?? "-")</td>
                                    <td>
                                        <button class="dropdown-item text-dark" onclick="viewPaymentDetail('@p.Id')">
                                            <i class="fa-solid fa-eye"></i> 
                                        </button>
                                    </td>
                                </tr>
                                index++;
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4 fst-italic">
                                    Không có giao dịch nào được tìm thấy.
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        @if (activeTab == "payout")
        {
            <!-- ========================== -->
            <!-- TAB: CLAIM PAYOUTS -->
            <!-- ========================== -->
            <div class="filter-section mb-3">
                <form method="get" id="filterForm2">
                    <input type="hidden" name="tab" value="payout" />
                    <div class="row mb-2 align-items-end">
                        <div class="col-md-4 position-relative">
                            <i class="fa-solid fa-magnifying-glass search-icon"></i>
                            <input type="text" name="search" value="@ViewBag.Search"
                                   class="input-input ps-5" placeholder="Tìm mã yêu cầu hoặc hợp đồng...">
                        </div>
                        <div class="col-md-3">
                            <select name="pay_method" class="select-input" onchange="this.form.submit()">
                                <option value="">Tất cả phương thức</option>
                                <option value="bank_transfer" selected="@(ViewBag.PayMethod == "bank_transfer")">Chuyển khoản ngân hàng</option>
                                <option value="cash" selected="@(ViewBag.PayMethod == "cash")">Tiền mặt</option>
                                <option value="credit_card" selected="@(ViewBag.PayMethod == "credit_card")">Thẻ tín dụng</option>
                                <option value="online" selected="@(ViewBag.PayMethod == "online")">Cổng thanh toán trực tuyến</option>
                            </select>
                        </div>


                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Từ ngày</label>
                            <input type="date" name="from_date" class="input-input" value="@ViewBag.FromDate">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Đến ngày</label>
                            <input type="date" name="to_date" class="input-input" value="@ViewBag.ToDate">
                        </div>
                        <div class="col-md-1 d-flex justify-content-start">
                            <button type="button" class="btn-outline-red"
                                    style="height:42px;"
                                    onclick="window.location='@Url.Action("Index", new { tab = "payout" })'">
                                <i class="fa-solid fa-rotate-left"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>


            <div class="table-wrapper mt-3">
                <table class="table align-middle mb-0">
                    <thead class="text-center">
                        <tr>
                            <th>
                                    <span>STT</span>
                            </th>
                            <th>MÃ YÊU CẦU</th>
                            <th>SỐ TIỀN (₫)</th>
                            <th>THỰC CHI (₫)</th>
                            <th>PHƯƠNG THỨC</th>
                            <th>NGÀY CHI TRẢ</th>
                            <th>THAM CHIẾU</th>
                            <th>THAO TÁC</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Items.Any())
                        {
                            var index = (Model.CurrentPage - 1) * Model.PageSize + 1;
                            foreach (var p in Model.Items)
                            {
                                <tr class="text-center">
                                    <td>
                                            <span>@index</span>
                                    </td>
                                    <td class="fw-semibold text-primary">@p.ClaimNo</td>
                                    <td>@String.Format("{0:N0}", p.ApprovedAmount)</td>
                                    <td>@String.Format("{0:N0}", p.PaidAmount)</td>
                                    <td>
                                        @{
                                            var payMethodVN = p.PayMethod switch
                                            {
                                                "bank_transfer" => "Chuyển khoản ngân hàng",
                                                "cash" => "Tiền mặt",
                                                "credit_card" => "Thẻ tín dụng",
                                                "online" => "Cổng thanh toán trực tuyến",
                                                _ => p.PayMethod ?? "-"
                                            };
                                        }
                                        @payMethodVN
                                    </td>
                                    <td>@(p.PaidAt != null ? ((DateTime)p.PaidAt).ToString("dd/MM/yyyy") : "-")</td>
                                    <td>@(p.Reference ?? "-")</td>
                                    <td class="text-center">
                                        <button type="button" class="dropdown-item textdark"
                                                onclick="viewPayoutDetail('@p.Id')">
                                            <i class="fa-solid fa-eye"></i> 
                                        </button>
                                    </td>
                                </tr>
                                index++;
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4 fst-italic">
                                    Không có chi trả nào được tìm thấy.
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        <div class="table-footer mt-3">
            @await Html.PartialAsync("_Paginator", Model)
        </div>
    </div>

    <!-- MODAL: Chi tiết lịch sử đóng phí -->
    <div class="modal fade" id="paymentDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg">

                <!-- HEADER -->
                <div class="modal-header custom-header">
                    <div class="d-flex align-items-center gap-3">
                        <div class="header-icon">
                            <i class="fa-solid fa-wallet"></i>
                        </div>
                        <div>
                            <h3 class="mb-0 text-white fw-bold">Chi tiết thanh toán phí bảo hiểm</h3>
                            <p class="mb-0 text-white-75 small" id="detailPolicyNo"></p>
                        </div>
                    </div>
                    <button type="button" class="btn-close btn-gray" data-bs-dismiss="modal"></button>
                </div>

                <!-- BODY -->
                <div class="modal-body custom-modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Mã hợp đồng</label>
                            <input type="text" id="detailPolicy" class="input-input bg-white" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Ngày đến hạn</label>
                            <input type="text" id="detailDueDate" class="input-input bg-white" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Ngày thanh toán</label>
                            <input type="text" id="detailPaidDate" class="input-input bg-white" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Số tiền (₫)</label>
                            <input type="text" id="detailAmount" class="input-input bg-white" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Kênh thanh toán</label>
                            <input type="text" id="detailChannel" class="input-input bg-white" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Mã tham chiếu</label>
                            <input type="text" id="detailRef" class="input-input bg-white" readonly />
                        </div>
                        <div class="col-md-12">
                            <label class="form-label fw-semibold">Trạng thái</label>
                            <input type="text" id="detailStatus" class="input-input bg-white" readonly />
                        </div>
                    </div>
                </div>

                <!-- FOOTER -->
                <div class="modal-footer custom-footer d-flex justify-content-end">
                    <button type="button" class="btn btn-sm btn-gray" data-bs-dismiss="modal">
                        Đóng
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Chi tiết chi trả quyền lợi -->
    <div class="modal fade" id="payoutDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg">

                <!-- HEADER -->
                <div class="modal-header custom-header">
                    <div class="d-flex align-items-center gap-3">
                        <div class="header-icon">
                            <i class="fa-solid fa-hand-holding-dollar"></i>
                        </div>
                        <div>
                            <h3 class="mb-0 text-white fw-bold">Chi tiết chi trả quyền lợi</h3>
                            <p class="mb-0 text-white-75 small" id="payoutClaimNoHeader"></p>
                        </div>
                    </div>
                    <button type="button" class="btn-close btn-gray" data-bs-dismiss="modal"></button>
                </div>

                <!-- BODY -->
                <div class="modal-body custom-modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Mã yêu cầu</label>
                            <input type="text" id="payoutClaimNo" class="input-input bg-white" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Mã hợp đồng</label>
                            <input type="text" id="payoutPolicyNo" class="input-input bg-white" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Số tiền yêu cầu (₫)</label>
                            <input type="text" id="payoutRequestedAmount" class="input-input bg-white text-dark" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold text-success">Số tiền được duyệt (₫)</label>
                            <input type="text" id="payoutApprovedAmount" class="input-input bg-white text-success fw-bold" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Số tiền thực chi (₫)</label>
                            <input type="text" id="payoutPaidAmount" class="input-input bg-white text-primary fw-bold" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Phương thức thanh toán</label>
                            <input type="text" id="payoutMethod" class="input-input bg-white" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Ngày chi trả</label>
                            <input type="text" id="payoutDate" class="input-input bg-white" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Mã tham chiếu</label>
                            <input type="text" id="payoutReference" class="input-input bg-white" readonly />
                        </div>
                    </div>
                </div>

                <!-- FOOTER -->
                <div class="modal-footer custom-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-sm btn-gray" data-bs-dismiss="modal">
                        Đóng
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script src="~/js/payment.js" asp-append-version="true"></script>
}